name: Deploy to Linode

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.LINODE_HOST }}" ]; then
            echo "::error::LINODE_HOST secret is not set. Please configure it in repository or environment secrets."
            exit 1
          fi
          if [ -z "${{ secrets.LINODE_USER }}" ]; then
            echo "::error::LINODE_USER secret is not set. Please configure it in repository or environment secrets."
            exit 1
          fi
          if [ -z "${{ secrets.LINODE_SSH_PRIVATE_KEY }}" ]; then
            echo "::error::LINODE_SSH_PRIVATE_KEY secret is not set. Please configure it in repository or environment secrets."
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"

      - name: Setup SSH
        run: |
          # Create .ssh directory
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write the private key with proper formatting
          # Remove any Windows line endings and ensure proper format
          # Support both RSA and ED25519 keys
          echo "${{ secrets.LINODE_SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Add the key to ssh-agent
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/deploy_key
          
          # Add Linode host to known_hosts to avoid host key verification prompt
          ssh-keyscan -H ${{ secrets.LINODE_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts
          
          # Test SSH connection
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }} echo "‚úÖ SSH connection successful"

      - name: Build application
        run: |
          echo "üì¶ Installing dependencies..."
          npm ci
          echo "üî® Building application..."
          npm run build

      - name: Deploy to Linode
        run: |
          DEPLOY_PATH="/opt/social-media-app"
          SSH_OPTS="-o StrictHostKeyChecking=no -i ~/.ssh/deploy_key"
          
          echo "üöÄ Starting deployment to ${{ secrets.LINODE_HOST }}..."
          
          # Create deployment directory on server
          ssh $SSH_OPTS ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }} "
            mkdir -p $DEPLOY_PATH
            mkdir -p $DEPLOY_PATH/.next
          "
          
          # Sync application files (excluding node_modules, .git, etc.)
          echo "üì§ Syncing files to server..."
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude '.next' \
            --exclude '.env.local' \
            --exclude '.env.*.local' \
            --exclude '*.log' \
            -e "ssh $SSH_OPTS" \
            ./ ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }}:$DEPLOY_PATH/
          
          # Sync .next build directory
          echo "üì§ Syncing build artifacts..."
          rsync -avz --delete \
            -e "ssh $SSH_OPTS" \
            ./apps/web/.next/ ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }}:$DEPLOY_PATH/apps/web/.next/
          
          # Install dependencies and restart on server
          echo "üì• Installing dependencies on server..."
          ssh $SSH_OPTS ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }} "
            cd $DEPLOY_PATH
            npm ci --production
            cd apps/web
            npm ci --production
          " || echo "‚ö†Ô∏è  npm install completed with warnings"
          
          # Restart application (adjust based on your process manager)
          echo "üîÑ Restarting application..."
          ssh $SSH_OPTS ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }} "
            cd $DEPLOY_PATH
            # If using PM2:
            # pm2 restart social-media-app || pm2 start npm --name social-media-app -- start
            # If using systemd:
            # systemctl restart social-media-app || echo 'Service not configured yet'
            # For now, just verify the deployment
            echo '‚úÖ Deployment completed. Please restart your application service manually if needed.'
          "
          
          echo "‚úÖ Deployment completed successfully!"
