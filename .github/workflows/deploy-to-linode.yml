name: Deploy to Linode

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.LINODE_HOST }}" ]; then
            echo "::error::LINODE_HOST secret is not set. Please configure it in repository or environment secrets."
            exit 1
          fi
          if [ -z "${{ secrets.LINODE_USER }}" ]; then
            echo "::error::LINODE_USER secret is not set. Please configure it in repository or environment secrets."
            exit 1
          fi
          if [ -z "${{ secrets.LINODE_SSH_PRIVATE_KEY }}" ]; then
            echo "::error::LINODE_SSH_PRIVATE_KEY secret is not set. Please configure it in repository or environment secrets."
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: Setup SSH
        run: |
          # Create .ssh directory
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write the private key with proper formatting
          # Remove any Windows line endings and ensure proper format
          echo "${{ secrets.LINODE_SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Add the key to ssh-agent
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa
          
          # Add Linode host to known_hosts to avoid host key verification prompt
          ssh-keyscan -H ${{ secrets.LINODE_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts
          
          # Test SSH connection
          ssh -o StrictHostKeyChecking=no ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }} echo "SSH connection successful"

      - name: Deploy to Linode
        run: |
          # Add your deployment commands here
          # Example:
          # rsync -avz --delete ./ ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }}:/path/to/deployment/
          # ssh ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }} 'cd /path/to/deployment && npm install && pm2 restart app'
          echo "Deployment steps would go here"
